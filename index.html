<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="jquery.timeago.js"></script>
  </head>
  <body>

    <input class="tweetbox"></input>
    <button class="send">Tweet</button>
    <button class="refresh">Refresh Tweets</button>

    <ul class = "feed">

    </ul>
    
    <style type="text/css">

      .refresh{
        float: bottom;
        margin-left: 180px;
        color: blue;
      }

      .tweetbox{
        margin-left: 30px;
      }

      button{
        margin-top: 50px;
      }

      input{
        margin-top: 50px;
      }

      div{
        border: 2px solid lightblue;
        width: 400px;
        overflow: auto;
        line-height: 20px;
        margin: 1px;
      }
      span{
        
        display: block;
        float:right;
        width: 60px;
        font-size: 10px;
        color: gray;
      }
      p{
        margin: 0;
      }
    </style>

    <script>

      $(document).ready(function(){
        var $body = $('body');
        // $body.html('');
        var index = streams.home.length - 1;
        var lastTime;

        //create code to create key val pair or add val to key for messages and users
        var userMsgs = {};
        // can't use addMsgs as is (it uses first tweet because of scope! (can't use within function))
        var addMsgs = function(){
          if(userMsgs.hasOwnProperty(tweet.user)){
            userMsgs[tweet.user].push(tweet.message);
          } else {
            userMsgs[tweet.user] = [tweet.message];
          }
        };

        // "human" timestamp
        // var createdAgo = function(){
        //   var date = new Date(); 
        //   var 
        // };
        
        // initial messages

        $("abbr.timeago").timeago();
        $.timeago.settings.allowFuture = true;

        while(index >= 0){
          tweet = streams.home[index];
          var $tweet = $('<div></div>');
          
          $tweet.html("<p><strong>"+"@"+tweet.user+"</strong></p>"+"<span>"+$.timeago(tweet.created_at) +"</span>"+"<p>"+tweet.message+"</p><br></br>");
          var currentTime = tweet.created_at.getDate();
          console.log(currentTime);
          $tweet.appendTo($(".feed"));
          index -= 1;
          lasTime = tweet.created_at;
          if(userMsgs.hasOwnProperty(tweet.user)){
            userMsgs[tweet.user].push(tweet.message);
          } else {
            userMsgs[tweet.user] = [tweet.message];
          }
        }

        var visitor = prompt("Please enter your name");
        if(visitor === null || visitor === ""){
          visitor = "Visitor";
        }

        var refreshFunction = function(){
          for(var x = msgCount; x<streams.home.length; x++){
            var tweet = streams.home[x];
            if(lastTime != tweet.created_at){
              var $tweet = $('<div></div>');
              $tweet.html("<p><strong>"+"@"+tweet.user+"</strong></p>"+"<span>"+$.timeago(tweet.created_at) +"</span>"+"<p>"+tweet.message+"</p><br></br>");
              console.log()
              if(userMsgs.hasOwnProperty(tweet.user)){
                userMsgs[tweet.user].push(tweet.message);
              } else {
                userMsgs[tweet.user] = [tweet.message];
              }
              $tweet.prependTo($(".feed"));
              var date = new Date();
              lastTime = tweet.created_at;
              msgCount += 1;
            }
          }
        };

        // refresh button
        var msgCount = streams.home.length;
        $(".refresh" || ".send").on("click", function(){
          refreshFunction()
        });

        //tweet button
        $(".send").on("click", function(){
          currentInput = $(".tweetbox").val();
          if(currentInput.length>0){
            writeTweet(currentInput, visitor);
            refreshFunction();
          }
          $(".tweetbox").val("");
        });

        $(".tweetbox").keydown(function(event){
          if(event.keyCode === 13){
            $(".send").trigger("click");
          }
        });


        // auto-refresh
        // setInterval(function(){
        //   var tweet = streams.home[streams.home.length-1];
        //   if(lastTime != tweet.created_at){
        //     var $tweet = $('<div></div>');
        //     $tweet.text('@' + tweet.user + ': ' + tweet.message);
        //     $tweet.prependTo($(".feed"));
        //     lastTime = tweet.created_at;
        //     msgCount += 1;
        //   }
        // }, 500);

      });

    </script>
  </body>
</html>
